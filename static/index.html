<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WildAtlas - Endangered Species Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo h1 {
            font-size: 1.8rem;
            color: #e94560;
            letter-spacing: 1px;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .subtitle {
            color: #aaa;
            font-size: 0.9rem;
        }

        main {
            display: flex;
            height: calc(100vh - 80px);
        }

        #map {
            flex: 1;
            height: 100%;
            z-index: 1;
        }

        #sidebar {
            width: 400px;
            background: #16213e;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        #sidebar.hidden {
            transform: translateX(100%);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #0f3460;
        }

        .sidebar-header h2 {
            color: #e94560;
            font-size: 1.4rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #e94560;
        }

        .country-info {
            margin-bottom: 1.5rem;
        }

        .country-name {
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .country-code {
            color: #888;
            font-size: 0.9rem;
        }

        .species-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .species-card {
            background: #0f3460;
            border-radius: 10px;
            padding: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .species-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.2);
        }

        .species-name {
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 0.3rem;
        }

        .scientific-name {
            font-style: italic;
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .status-critically-endangered {
            background: #dc3545;
            color: #fff;
        }

        .status-endangered {
            background: #fd7e14;
            color: #fff;
        }

        .status-vulnerable {
            background: #ffc107;
            color: #000;
        }

        .status-near-threatened {
            background: #20c997;
            color: #fff;
        }

        .status-default {
            background: #6c757d;
            color: #fff;
        }

        .species-details {
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .species-details p {
            margin-bottom: 0.3rem;
            color: #ccc;
        }

        .species-details strong {
            color: #e94560;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .placeholder-message {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .placeholder-message .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Leaflet customization */
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: #fff;
            border-radius: 8px;
        }

        .leaflet-popup-content {
            margin: 10px 15px;
        }

        .leaflet-popup-tip {
            background: #16213e;
        }

        .country-popup {
            text-align: center;
        }

        .country-popup h3 {
            color: #e94560;
            margin-bottom: 0.5rem;
        }

        .country-popup p {
            font-size: 0.9rem;
            color: #ccc;
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }

            #map {
                height: 50vh;
            }

            #sidebar {
                width: 100%;
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-icon">üåç</span>
            <div>
                <h1>WildAtlas</h1>
                <p class="subtitle">Discover endangered species around the world</p>
            </div>
        </div>
    </header>

    <main>
        <div id="map"></div>
        <aside id="sidebar">
            <div id="sidebar-content">
                <div class="placeholder-message">
                    <div class="icon">ü¶Å</div>
                    <h3>Click on a country</h3>
                    <p>Select a country on the map to view its endangered species</p>
                </div>
            </div>
        </aside>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([20, 0], 2);

        // Add tile layer (using a dark theme to match our design)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Country boundaries GeoJSON URL
        const countriesGeoJsonUrl = 'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson';

        let geojsonLayer;
        let selectedCountry = null;

        // Style for countries
        function style(feature) {
            return {
                fillColor: '#0f3460',
                weight: 1,
                opacity: 1,
                color: '#16213e',
                fillOpacity: 0.7
            };
        }

        // Highlight style on hover
        function highlightStyle(feature) {
            return {
                fillColor: '#e94560',
                weight: 2,
                opacity: 1,
                color: '#fff',
                fillOpacity: 0.7
            };
        }

        // Selected style
        function selectedStyle(feature) {
            return {
                fillColor: '#e94560',
                weight: 3,
                opacity: 1,
                color: '#fff',
                fillOpacity: 0.8
            };
        }

        // Reset highlight
        function resetHighlight(e) {
            if (e.target !== selectedCountry) {
                geojsonLayer.resetStyle(e.target);
            }
        }

        // Highlight on hover
        function highlightFeature(e) {
            const layer = e.target;
            if (layer !== selectedCountry) {
                layer.setStyle(highlightStyle());
            }
            layer.bringToFront();
        }

        // Handle country click
        function onCountryClick(e) {
            const layer = e.target;
            const properties = layer.feature.properties;
            const countryCode = properties.ISO_A2;
            const countryName = properties.ADMIN;

            // Reset previous selection
            if (selectedCountry) {
                geojsonLayer.resetStyle(selectedCountry);
            }

            // Set new selection
            selectedCountry = layer;
            layer.setStyle(selectedStyle());

            // Zoom to country
            map.fitBounds(layer.getBounds(), { padding: [50, 50] });

            // Fetch species data
            fetchSpeciesData(countryCode, countryName);
        }

        // Add interactions to each country
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: onCountryClick
            });
        }

        // Fetch and display species data
        async function fetchSpeciesData(countryCode, countryName) {
            const sidebar = document.getElementById('sidebar-content');
            
            // Show loading state
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <h2>Endangered Species</h2>
                </div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading species data...</p>
                </div>
            `;

            try {
                const response = await fetch(`/api/species/${countryCode}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displaySpeciesData(data);
            } catch (error) {
                console.error('Error fetching species data:', error);
                sidebar.innerHTML = `
                    <div class="sidebar-header">
                        <h2>Endangered Species</h2>
                    </div>
                    <div class="error-message">
                        <p>Failed to load species data for ${countryName}</p>
                        <p>Please try again later.</p>
                    </div>
                `;
            }
        }

        // Display species data in sidebar
        function displaySpeciesData(data) {
            const sidebar = document.getElementById('sidebar-content');
            
            let speciesHtml = data.species.map(species => {
                const statusClass = getStatusClass(species.status);
                return `
                    <div class="species-card">
                        <h4 class="species-name">${escapeHtml(species.name)}</h4>
                        <p class="scientific-name">${escapeHtml(species.scientific_name)}</p>
                        <span class="status-badge ${statusClass}">${escapeHtml(species.status)}</span>
                        <div class="species-details">
                            ${species.population ? `<p><strong>Population:</strong> ${escapeHtml(species.population)}</p>` : ''}
                            ${species.habitat ? `<p><strong>Habitat:</strong> ${escapeHtml(species.habitat)}</p>` : ''}
                            ${species.threats ? `<p><strong>Threats:</strong> ${escapeHtml(species.threats)}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <h2>Endangered Species</h2>
                </div>
                <div class="country-info">
                    <h3 class="country-name">${escapeHtml(data.country)}</h3>
                    <p class="country-code">Country Code: ${escapeHtml(data.country_code)}</p>
                </div>
                <div class="species-list">
                    ${speciesHtml}
                </div>
            `;
        }

        // Get CSS class for status badge
        function getStatusClass(status) {
            const lowerStatus = status.toLowerCase();
            if (lowerStatus.includes('critically')) return 'status-critically-endangered';
            if (lowerStatus.includes('endangered')) return 'status-endangered';
            if (lowerStatus.includes('vulnerable')) return 'status-vulnerable';
            if (lowerStatus.includes('near threatened')) return 'status-near-threatened';
            return 'status-default';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load countries GeoJSON
        fetch(countriesGeoJsonUrl)
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJSON(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);
            })
            .catch(error => {
                console.error('Error loading countries GeoJSON:', error);
            });
    </script>
</body>
</html>
